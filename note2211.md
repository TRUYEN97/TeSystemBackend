# Tài liệu mô hình Domain & Phân quyền - TeSystemBackend

## PHẦN 1: MỤC ĐÍCH VÀ Ý NGHĨA TỪNG CLASS

### 1. Software Management Entities

#### Software
- **Mục đích**: Đại diện cho một phần mềm trong hệ thống
- **Ý nghĩa**: Là entity gốc, mỗi Software có thể có nhiều phiên bản (SwVersion)
- **Fields chính**: Name, Description, Vendor, IsActive
- **Quan hệ**: 1 → N với SwVersion, N → N với Computer (qua ComputerSoftware)

#### SwVersion
- **Mục đích**: Đại diện cho một phiên bản cụ thể của Software
- **Ý nghĩa**: Mỗi phiên bản có thể có nhiều file (SwFile), hỗ trợ cơ chế Incremental Update/Patch Update
- **Fields chính**: Version (ví dụ: "1.0.0", "2.1.3"), ReleaseNotes, ReleasedAt
- **Quan hệ**: N → 1 với Software, 1 → N với SwFile

#### SwFile
- **Mục đích**: Đại diện cho một file trong SwVersion
- **Ý nghĩa**: Lưu thông tin file để so sánh MD5 khi update, hỗ trợ manifest-based update
- **Fields chính**: 
  - RelativePath: Đường dẫn tương đối (ví dụ: "bin/app.exe")
  - Size: Kích thước file (bytes)
  - Md5: Checksum để so sánh file khi update
  - DownloadUrl: URL để download file
- **Quan hệ**: N → 1 với SwVersion
- **Index**: Md5 (để lookup nhanh khi so sánh)

### 2. Computer Management Entities

#### Computer
- **Mục đích**: Đại diện cho một máy tính trong hệ thống
- **Ý nghĩa**: Track các máy tính có thể cài đặt Software
- **Fields chính**: Name, MacAddress, IpAddress, OperatingSystem, LastSeenAt
- **Quan hệ**: N → N với Software (qua ComputerSoftware), 1 → N với InstallationHistory

#### ComputerSoftware
- **Mục đích**: Bảng trung gian track Software đã cài trên Computer và phiên bản hiện tại
- **Ý nghĩa**: Cho phép một Computer cài nhiều Software, mỗi Software có thể ở phiên bản khác nhau
- **Fields chính**: 
  - InstalledSwVersionId: Phiên bản hiện đang cài (nullable)
  - InstalledAt: Thời gian cài đặt
  - LastUpdatedAt: Thời gian cập nhật cuối
- **Quan hệ**: N → 1 với Computer, N → 1 với Software, N → 1 với SwVersion (optional)

### 3. Authorization Entities

#### AppUser
- **Mục đích**: Người dùng hệ thống, kế thừa từ IdentityUser<int> của ASP.NET Core Identity
- **Ý nghĩa**: Tận dụng sẵn các tính năng authentication/authorization của Identity
- **Fields chính**: 
  - FirstName, LastName: Thông tin cá nhân
  - TeamId: Thuộc Team nào (nullable)
  - IsActive: Trạng thái hoạt động
- **Quan hệ**: N → 1 với Team, 1 → N với AclEntry (CreatedBy), 1 → N với InstallationHistory, 1 → N với ChangeLog
- **Kế thừa**: IdentityUser<int> cung cấp sẵn: Id, UserName, Email, PasswordHash, Roles, Claims...

#### Team
- **Mục đích**: Team có cấu trúc phân cấp (hierarchical)
- **Ý nghĩa**: Hỗ trợ kế thừa quyền từ Team → User, và từ Parent Team → Child Team
- **Fields chính**: 
  - Name, Description
  - ParentTeamId: Team cha (nullable, cho phép phân cấp)
  - DepartmentId: Thuộc Department nào (nullable)
- **Quan hệ**: 
  - N → 1 với Team (ParentTeam)
  - N → 1 với Department
  - 1 → N với Team (ChildTeams)
  - 1 → N với AppUser
  - 1 → N với AclEntry (PrincipalType = Team)

#### Department
- **Mục đích**: Đơn vị tổ chức có cấu trúc phân cấp (hierarchical)
- **Ý nghĩa**: Cấp cao hơn Team, hỗ trợ kế thừa quyền từ Department → Team → User
- **Fields chính**: 
  - Name, Description, Code
  - ParentDepartmentId: Department cha (nullable, cho phép phân cấp)
- **Quan hệ**: 
  - N → 1 với Department (ParentDepartment)
  - 1 → N với Department (ChildDepartments)
  - 1 → N với Team
  - 1 → N với AclEntry (PrincipalType = Department)

#### AclEntry
- **Mục đích**: Bản ghi phân quyền cho resource cụ thể (Access Control List Entry)
- **Ý nghĩa**: Cho phép phân quyền chi tiết đến từng object (Computer, Software, SwVersion, SwFile)
- **Fields chính**: 
  - ResourceType + ResourceId: Resource được bảo vệ (Computer, Software, SwVersion, SwFile)
  - PrincipalType + PrincipalId: Ai được cấp quyền (User, Team, Role, Department)
  - Permission: Quyền cụ thể (string, ví dụ: "Read", "Write", "Delete", "Install")
  - AceOrder: Thứ tự ưu tiên (số nhỏ = ưu tiên cao hơn, tương tự ace_order trong Spring ACL)
  - IsAllow/IsDeny: Cho phép hoặc từ chối (tương tự granting trong Spring ACL)
  - IsInherited: Quyền được kế thừa từ cấp trên
  - GrantFromScopeId: Track scope gốc khi grant tạm thời (ví dụ: User hỗ trợ Team khác)
  - ExpiresAt: Thời gian hết hạn cho quyền tạm thời (nullable)
  - CreatedBy: User tạo entry này
- **Quan hệ**: N → 1 với AppUser (CreatedByUser)
- **Index**: ResourceType + ResourceId, PrincipalType + PrincipalId (để lookup nhanh)

### 4. Audit Entities

#### InstallationHistory
- **Mục đích**: Lịch sử cài đặt/cập nhật/gỡ Software trên Computer
- **Ý nghĩa**: Audit trail để track ai cài gì, khi nào, phiên bản nào
- **Fields chính**: 
  - ComputerId, SoftwareId, SwVersionId
  - Action: Install, Update, hoặc Uninstall
  - InstalledBy: User thực hiện (nullable)
  - InstalledAt: Thời gian thực hiện
  - Notes: Ghi chú
- **Quan hệ**: N → 1 với Computer, N → 1 với Software, N → 1 với SwVersion, N → 1 với AppUser (optional)

#### ChangeLog
- **Mục đích**: Lịch sử thay đổi các entities quan trọng (đặc biệt là ACL)
- **Ý nghĩa**: Audit trail để track mọi thay đổi trong hệ thống
- **Fields chính**: 
  - EntityType: Loại entity (string, ví dụ: "AclEntry", "Software", "Computer")
  - EntityId: ID của entity
  - ChangeType: Create, Update, Delete, Grant, Revoke
  - OldValue/NewValue: Giá trị cũ/mới (JSON string)
  - ChangedBy: User thực hiện
  - ChangedAt: Thời gian thay đổi
- **Quan hệ**: N → 1 với AppUser (ChangedByUser)

---

## PHẦN 2: LIÊN HỆ GIỮA CÁC CLASS

### 2.1. Software Management Flow

```
Software (1)
  └─→ SwVersion (N)
        └─→ SwFile (N)
```

**Mối quan hệ**:
- Một Software có nhiều SwVersion
- Một SwVersion có nhiều SwFile
- SwFile chứa MD5 để so sánh khi update (Incremental Update pattern)

### 2.2. Computer-Software Installation Flow

```
Computer (N) ←→ ComputerSoftware (N) ←→ Software (N)
                      ↓
                  SwVersion (1)
```

**Mối quan hệ**:
- Computer có thể cài nhiều Software (N-N qua ComputerSoftware)
- ComputerSoftware track SwVersion hiện đang cài (InstalledSwVersionId)
- Mỗi lần cài/update được ghi vào InstallationHistory

### 2.3. Authorization Hierarchy

```
Department (1)
  └─→ Team (N)
        └─→ AppUser (N)
              └─→ AclEntry (N) → Resource (Computer/Software/SwVersion/SwFile)
```

**Mối quan hệ**:
- Department có thể có nhiều Team (hierarchical với ParentDepartmentId)
- Team có thể có nhiều Team con (hierarchical với ParentTeamId)
- Team có nhiều AppUser
- AppUser có thể có nhiều AclEntry (direct grants)
- Team/Department/Role có thể có AclEntry (inherited grants)

### 2.4. Audit Trail Flow

```
AppUser (1)
  ├─→ InstallationHistory (N) → Computer, Software, SwVersion
  └─→ ChangeLog (N) → Any Entity
```

**Mối quan hệ**:
- Mọi thao tác cài đặt được ghi vào InstallationHistory
- Mọi thay đổi quan trọng được ghi vào ChangeLog
- Cả hai đều track User thực hiện

### 2.5. ACL Permission Flow

```
Resource (Computer/Software/SwVersion/SwFile)
  ←─ AclEntry (N)
      ├─ Principal: AppUser (direct)
      ├─ Principal: Team (inherited by User)
      ├─ Principal: Department (inherited by Team → User)
      └─ Principal: Role (inherited by User with Role)
```

**Mối quan hệ**:
- Một Resource có thể có nhiều AclEntry
- Một AclEntry có thể grant cho User, Team, Department, hoặc Role
- Quyền được evaluate theo thứ tự: Direct → Team → Parent Team → Department → Role

---

## PHẦN 3: GIẢI THÍCH MÔ HÌNH PHÂN QUYỀN

### 3.1. Các thành phần chính

**AclEntry** - Bản ghi phân quyền:
- `ResourceType` + `ResourceId`: Resource được bảo vệ (Computer, Software, SwVersion, SwFile)
- `PrincipalType` + `PrincipalId`: Ai được cấp quyền (User, Team, Role, Department)
- `Permission`: Quyền cụ thể ("Read", "Write", "Delete", "Install", "Update")
- `AceOrder`: Thứ tự ưu tiên (số nhỏ = ưu tiên cao hơn, tương tự `ace_order` trong Spring ACL)
- `IsAllow`/`IsDeny`: Cho phép hoặc từ chối (tương tự `granting` trong Spring ACL, nhưng rõ ràng hơn với 2 fields)
- `IsInherited`: Quyền được kế thừa từ cấp trên
- `GrantFromScopeId`: Track scope gốc khi cấp quyền tạm thời (ví dụ: User hỗ trợ Team khác)
- `ExpiresAt`: Thời gian hết hạn cho quyền tạm thời (nullable)

### 3.2. Các case phân quyền chính

#### Case 1: Phân quyền trực tiếp (Direct Grant)
```
User A → Read permission → Software X
```
- `PrincipalType = User`, `PrincipalId = A`
- `IsInherited = false`
- `AceOrder = 1` (ưu tiên cao nhất)

#### Case 2: Phân quyền qua Team
```
Team Dev → Write permission → Software X
User A thuộc Team Dev → tự động có Write
```
- `PrincipalType = Team`, `PrincipalId = Dev`
- `IsInherited = false` (cho Team)
- Khi User A check: `IsInherited = true` (kế thừa từ Team)

#### Case 3: Kế thừa phân cấp (Hierarchical Inheritance)
```
Department IT → Read → Software X
  └─ Team Dev → Write → Software X
      └─ User A → có cả Read (từ Dept) và Write (từ Team)
```
- Thứ tự evaluate: User direct → Team → Parent Team → Department → Role
- `AceOrder` quyết định thứ tự khi có nhiều entry

#### Case 4: Deny Override (Từ chối có ưu tiên cao nhất)
```
User A → Allow Read → Software X (AceOrder = 2)
Team Dev → Deny Read → Software X (AceOrder = 1)
→ Kết quả: User A KHÔNG có Read (Deny override Allow)
```
- `IsDeny = true` luôn thắng `IsAllow = true`
- `AceOrder` nhỏ hơn = ưu tiên cao hơn

#### Case 5: Grant tạm thời (Temporary Grant)
```
User A hỗ trợ Team B → Grant Write tạm thời 7 ngày
```
- `PrincipalType = User`, `PrincipalId = A`
- `GrantFromScopeId = TeamB.Id`
- `ExpiresAt = DateTime.Now.AddDays(7)`
- Sau 7 ngày: entry tự động không còn hiệu lực

#### Case 6: Role-based Permission
```
Role Admin → Full Access → All Software
User A có Role Admin → tự động có Full Access
```
- `PrincipalType = Role`, `PrincipalId = Admin`
- Áp dụng cho tất cả User có Role này

### 3.3. Algorithm evaluate quyền

```
1. Load tất cả AclEntry cho Resource + User:
   - Direct User entries (IsInherited = false)
   - Team entries (User thuộc Team)
   - Parent Team entries (đệ quy lên)
   - Department entries (Team thuộc Department, đệ quy lên)
   - Role entries (User có Role)

2. Sort theo AceOrder (tăng dần)

3. Loop qua từng entry:
   - Nếu ExpiresAt < Now → skip
   - Nếu IsDeny = true → return DENY (dừng ngay)
   - Nếu IsAllow = true → ghi nhận ALLOW

4. Return kết quả cuối cùng
```

### 3.4. So sánh với Java Spring ACL

| Spring ACL | Mô hình hiện tại | Trạng thái |
|------------|------------------|------------|
| `ace_order` | `AceOrder` | ✅ Có |
| `granting` (true/false) | `IsAllow`/`IsDeny` (2 fields) | ✅ Có (rõ ràng hơn) |
| `sid` (Security Identity) | `PrincipalType` + `PrincipalId` | ✅ Có |
| `acl_object_identity` | `ResourceType` + `ResourceId` | ✅ Có |
| `mask` (bit permission) | `Permission` (string) | ✅ Có (linh hoạt hơn) |
| Inheritance | `IsInherited` + hierarchical | ✅ Có |
| Temporary grant | `ExpiresAt` + `GrantFromScopeId` | ✅ Có (Spring ACL không có sẵn) |

### 3.5. Kết luận

**Mô hình hiện tại đã phục vụ được các vai trò tương tự Spring ACL:**
- ✅ `AceOrder` = `ace_order` (thứ tự ưu tiên)
- ✅ `IsAllow`/`IsDeny` = `granting` (rõ ràng hơn với 2 fields)
- ✅ Hỗ trợ thêm: Temporary grants, Hierarchical inheritance, Grant tracking

**Có thể triển khai đầy đủ các case phân quyền như Spring ACL và một số tính năng bổ sung.**

---

## PHẦN 4: TÓM TẮT QUAN HỆ GIỮA CÁC ENTITY

### 4.1. Software Management
- **Software** 1→N **SwVersion** 1→N **SwFile**
- Mục đích: Quản lý phần mềm, phiên bản, và file manifest cho incremental update

### 4.2. Computer Installation
- **Computer** N←→N **Software** (qua **ComputerSoftware**)
- **ComputerSoftware** N→1 **SwVersion** (track version đang cài)
- **InstallationHistory** ghi lại mọi thao tác cài/update/uninstall

### 4.3. Authorization Hierarchy
- **Department** 1→N **Team** 1→N **AppUser**
- **AclEntry** kết nối Principal (User/Team/Department/Role) với Resource (Computer/Software/SwVersion/SwFile)
- Hỗ trợ kế thừa quyền theo cấu trúc phân cấp

### 4.4. Audit Trail
- **InstallationHistory**: Track cài đặt Software
- **ChangeLog**: Track thay đổi entities (đặc biệt ACL)
- Cả hai đều link với **AppUser** để biết ai thực hiện

---

*Tài liệu được tạo ngày: 22/11/2024*

